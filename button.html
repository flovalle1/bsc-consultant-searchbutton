<style>
    /* Floating Button */
    #fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1d4b73;
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-weight: bold;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: background-color 0.3s;
    }

    #fab:hover {
        background-color: #173a59;
    }

    /* Slide-out Panel */
    #expert-panel {
        position: fixed;
        top: 0;
        right: -100%;
        width: 33%;
        height: 100%;
        background-color: #204060;
        color: white;
        box-shadow: -2px 0 6px rgba(0, 0, 0, 0.3);
        transition: right 0.3s ease;
        z-index: 9998;
        padding: 20px;
        display: flex;
        flex-direction: column;
        visibility: hidden;
        overflow: hidden;
    }

    #expert-panel.open {
        right: 0;
        visibility: visible;
    }

    /* Header */
    #expert-panel h2 {
        margin: 0 0 10px;
        font-size: 1.4rem;
    }

    /* Search Input */
    #expert-search {
        display: flex;
        margin-bottom: 15px;
    }

    #expert-search input {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px 0 0 4px;
    }

    #expert-search button {
        background: white;
        border: none;
        border-radius: 0 4px 4px 0;
        padding: 8px 12px;
        cursor: pointer;
    }

    /* Consultant List */
    .consultant {
        background: #173a59;
        border-radius: 8px;
        padding: 10px;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .consultant:hover {
        background: #102840;
    }

    .consultant img {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        margin-right: 10px;
        object-fit: cover;
    }

    .consultant-info {
        display: flex;
        flex-direction: column;
    }

    .consultant-name {
        font-weight: bold;
    }

    .consultant-address {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .consultant-city {
        font-size: 0.85rem;
        color: #4CAF50;
        margin-top: 2px;
    }

    .consultant-distance {
        font-size: 0.8rem;
        color: #4CAF50;
        margin-top: 2px;
    }

    .consultant-expertise {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 4px;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }

    .expertise-tag {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    /* Loading State */
    .loading {
        text-align: center;
        padding: 20px;
        opacity: 0.7;
    }

    .error {
        text-align: center;
        padding: 20px;
        color: #ff6b6b;
        background-color: rgba(255, 107, 107, 0.1);
        border-radius: 4px;
        margin: 10px 0;
    }

    /* Location Search */
    #location-search {
        margin-bottom: 15px;
    }

    #location-input {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    #city-select {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        display: none;
        margin-bottom: 10px;
        background: white;
        color: #333;
    }

    /* City Results List */
    #city-results {
        background: white;
        color: #333;
        border-radius: 4px;
        margin-bottom: 10px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .city-result-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }

    .city-result-item:hover {
        background-color: #f5f5f5;
    }

    .city-result-item:last-child {
        border-bottom: none;
    }

    .city-result-name {
        font-weight: bold;
        font-size: 0.9rem;
    }

    .city-result-details {
        font-size: 0.8rem;
        color: #666;
        margin-top: 2px;
    }

    /* Expertise Chips */
    #expertise-chips {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        margin: 15px 0;
        padding: 15px 0;
    }

    #chips-container {
        max-height: 100px;
        overflow-y: auto;
        padding-right: 5px;
    }

    .chip {
        display: inline-block;
        background: #173a59;
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        margin: 2px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s;
        border: 1px solid transparent;
        user-select: none;
    }

    .chip:hover {
        background: #102840;
    }

    .chip.active {
        background: #4CAF50;
        border-color: #45a049;
    }

    .chip.disabled {
        background: #666;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .search-hint {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 8px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        #expert-panel {
            width: 90%;
        }

        #expert-panel.open {
            right: 5%;
        }

        #fab {
            bottom: 15px;
            right: 15px;
            width: 50px;
            height: 50px;
        }
    }

    @media (max-width: 480px) {
        #expert-panel {
            width: 95%;
        }

        #expert-panel.open {
            right: 2.5%;
        }
    }

    /* Consultant List Container */
    #consultant-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        min-height: 200px;
    }
</style>

<div id="fab">üîç</div>

<div id="expert-panel">
    <h2>Finde einen Experten in deiner N√§he!</h2>

    <!-- Location Search -->
    <div id="location-search">
        <div class="search-hint">üè† Standort f√ºr Entfernungsberechnung:</div>
        <input type="text" id="location-input" placeholder="Ort oder PLZ eingeben (mind. 3 Zeichen)">
        <select id="city-select">
            <option value="">Stadt ausw√§hlen...</option>
        </select>
        <div id="city-results"></div>
    </div>

    <!-- Name Search -->
    <div id="expert-search">
        <input type="text" id="search-input" placeholder="üîç Nach Name oder Stadt suchen">
        <button>üîç</button>
    </div>

    <!-- Expertise Chips -->
    <div id="expertise-chips">
        <div style="font-size: 0.9rem; margin-bottom: 8px; opacity: 0.8;">
            üè∑Ô∏è Expertise filtern: <span id="filter-count"></span>
        </div>
        <div id="chips-container"></div>
    </div>

    <!-- Consultant List -->
    <div id="consultant-list"></div>
</div>

<script>
    (function () {
        let consultants = [];
        let expertiseData = [];
        let isLoading = false;
        let userLocation = null;
        let activeExpertiseFilters = new Set();

        const fab = document.getElementById('fab');
        const panel = document.getElementById('expert-panel');
        const listContainer = document.getElementById('consultant-list');
        const searchInput = document.getElementById('search-input');
        const locationInput = document.getElementById('location-input');
        const citySelect = document.getElementById('city-select');
        const cityResults = document.getElementById('city-results');
        const chipsContainer = document.getElementById('chips-container');
        const filterCountElement = document.getElementById('filter-count');

        // Utility Functions
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius der Erde in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getExpertiseNames(expertiseIds) {
            return expertiseIds
                .map(id => expertiseData.find(exp => exp.id === id))
                .filter(exp => exp)
                .map(exp => exp.name);
        }

        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&limit=10`);
                const data = await response.json();

                // Filter nur St√§dte, Orte und Gemeinden
                const cityTypes = ['city', 'town', 'village', 'municipality', 'administrative'];
                return data.filter(location => {
                    return cityTypes.includes(location.type) ||
                        cityTypes.includes(location.class) ||
                        location.display_name.includes('Stadt') ||
                        location.display_name.includes('Gemeinde') ||
                        (location.addresstype && ['city', 'town', 'village', 'municipality'].includes(location.addresstype));
                }).slice(0, 5); // Limitiere auf 5 St√§dte
            } catch (error) {
                console.error('Error searching location:', error);
                return [];
            }
        }

        function renderCityResults(locations) {
            cityResults.innerHTML = '';

            if (locations.length === 0) {
                cityResults.style.display = 'none';
                return;
            }

            locations.forEach(location => {
                const item = document.createElement('div');
                item.className = 'city-result-item';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'city-result-name';
                // Extrahiere den Hauptort aus dem display_name
                const parts = location.display_name.split(',');
                const cityName = parts[0] + (parts[1] ? ', ' + parts[1].trim() : '');
                nameDiv.textContent = cityName;

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'city-result-details';
                detailsDiv.textContent = location.display_name;

                item.appendChild(nameDiv);
                item.appendChild(detailsDiv);

                item.onclick = () => selectCity(location);

                cityResults.appendChild(item);
            });

            cityResults.style.display = 'block';
        }

        function selectCity(location) {
            userLocation = {
                lat: parseFloat(location.lat),
                lng: parseFloat(location.lon),
                display_name: location.display_name
            };

            console.log('Selected location:', userLocation);

            // Update input field with selected city
            const parts = location.display_name.split(',');
            const cityName = parts[0] + (parts[1] ? ', ' + parts[1].trim() : '');
            locationInput.value = cityName;

            // Hide results
            cityResults.style.display = 'none';

            // Update distances
            updateDistances();
        }

        // API Functions
        async function fetchConsultants() {
            if (isLoading) return;

            isLoading = true;
            showLoading();

            try {
                console.log('Fetching consultants...');
                const response = await fetch('https://bsc-experten.de/wp-json/wp/v2/berater');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Received data:', data);

                consultants = data.map(consultant => {
                    console.log('Processing consultant:', consultant.title.rendered);
                    const acf = consultant.acf || {};
                    const openStreetMap = acf.openstreetmap || {};

                    return {
                        name: consultant.title.rendered,
                        image: consultant.yoast_head_json?.og_image?.[0]?.url ||
                            'https://via.placeholder.com/150x150/1d4b73/ffffff?text=' + encodeURIComponent(consultant.title.rendered.charAt(0)),
                        link: consultant.link,
                        id: consultant.id,
                        slug: consultant.slug,
                        // ACF Daten
                        address: acf['berater-anschrift'] || '',
                        city: acf['berater-ort'] || '',
                        phone: acf['berater-kontakttelefon'] || '',
                        email: acf['berater-email'] || '',
                        subtitle: acf['experte_fuer'] || 'BSC | Die Finanzberater',
                        // Koordinaten aus OpenStreetMap
                        latitude: openStreetMap.lat || null,
                        longitude: openStreetMap.lng || null,
                        // Expertise IDs
                        expertise: consultant.expertise || [],
                        distance: null
                    };
                });

                console.log('Processed consultants:', consultants);
                renderList();
            } catch (error) {
                console.error('Fehler beim Laden der Berater:', error);
                showError('Fehler beim Laden der Berater. Bitte versuchen Sie es sp√§ter erneut.');
            } finally {
                isLoading = false;
            }
        }

        async function fetchExpertise() {
            try {
                console.log('Fetching expertise...');
                const response = await fetch('https://bsc-experten.de/wp-json/wp/v2/expertise');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                expertiseData = await response.json();
                console.log('Received expertise data:', expertiseData);
                renderExpertiseChips();
            } catch (error) {
                console.error('Fehler beim Laden der Expertise:', error);
            }
        }

        function updateDistances() {
            if (!userLocation) return;

            consultants.forEach(consultant => {
                if (consultant.latitude && consultant.longitude) {
                    consultant.distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        consultant.latitude, consultant.longitude
                    );
                } else {
                    consultant.distance = null;
                }
            });

            // Sortiere nach Entfernung
            consultants.sort((a, b) => {
                if (a.distance === null && b.distance === null) return 0;
                if (a.distance === null) return 1;
                if (b.distance === null) return -1;
                return a.distance - b.distance;
            });

            renderList();
        }

        function showLoading() {
            listContainer.innerHTML = '<div class="loading">Lade Berater...</div>';
        }

        function showError(message) {
            listContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        function renderExpertiseChips() {
            chipsContainer.innerHTML = '';

            // Filter nur Hauptkategorien (parent = 0) und sortiere nach Namen
            const mainExpertise = expertiseData
                //.filter(exp => exp.parent === 0 && exp.count > 0)
                .sort((a, b) => a.name.localeCompare(b.name));

            mainExpertise.forEach(expertise => {
                const chip = document.createElement('div');
                chip.className = 'chip';
                chip.textContent = expertise.name;
                chip.onclick = () => toggleExpertiseFilter(expertise.id);
                chip.dataset.expertiseId = expertise.id;
                chipsContainer.appendChild(chip);
            });

            // Initialisiere Filter Count
            updateFilterCount();
        }

        function toggleExpertiseFilter(expertiseId) {
            if (activeExpertiseFilters.has(expertiseId)) {
                activeExpertiseFilters.delete(expertiseId);
            } else {
                activeExpertiseFilters.add(expertiseId);
            }

            // Update chip appearance
            const chips = chipsContainer.querySelectorAll('.chip');
            chips.forEach(chip => {
                const chipExpertiseId = parseInt(chip.dataset.expertiseId);
                chip.classList.toggle('active', activeExpertiseFilters.has(chipExpertiseId));
            });

            // Update filter count
            updateFilterCount();

            renderList();
        }

        function updateFilterCount() {
            const count = activeExpertiseFilters.size;
            if (count === 0) {
                filterCountElement.textContent = '(alle anzeigen)';
                filterCountElement.style.color = 'rgba(255, 255, 255, 0.5)';
            } else {
                filterCountElement.textContent = `(${count} aktiv)`;
                filterCountElement.style.color = '#4CAF50';
            }
        }

        function renderList(nameFilter = "") {
            if (isLoading) return;

            console.log('Rendering list with filter:', nameFilter);
            console.log('Active expertise filters:', Array.from(activeExpertiseFilters));
            console.log('Available consultants:', consultants);

            listContainer.innerHTML = "";

            let filteredConsultants = consultants.filter(c => {
                // Name/Stadt Filter
                const matchesName = c.name.toLowerCase().includes(nameFilter.toLowerCase()) ||
                    c.city.toLowerCase().includes(nameFilter.toLowerCase()) ||
                    c.address.toLowerCase().includes(nameFilter.toLowerCase());

                // Expertise Filter
                const matchesExpertise = activeExpertiseFilters.size === 0 ||
                    c.expertise.some(expId => activeExpertiseFilters.has(expId));

                return matchesName && matchesExpertise;
            });

            console.log('Filtered consultants:', filteredConsultants);

            filteredConsultants.forEach(c => {
                console.log('Creating element for:', c.name);

                const item = document.createElement('div');
                item.className = 'consultant';
                item.onclick = () => window.open(c.link, '_blank');

                // Fallback-Bild wenn das Laden fehlschl√§gt
                const imgElement = document.createElement('img');
                imgElement.src = c.image;
                imgElement.alt = c.name;
                imgElement.onerror = function () {
                    this.src = `https://via.placeholder.com/50x50/1d4b73/ffffff?text=${encodeURIComponent(c.name.charAt(0))}`;
                };

                const infoDiv = document.createElement('div');
                infoDiv.className = 'consultant-info';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'consultant-name';
                nameDiv.textContent = c.name;

                const addressDiv = document.createElement('div');
                addressDiv.className = 'consultant-address';
                addressDiv.textContent = c.subtitle;

                // Stadt anzeigen
                if (c.city) {
                    const cityDiv = document.createElement('div');
                    cityDiv.className = 'consultant-city';
                    cityDiv.textContent = c.city;
                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(addressDiv);
                    infoDiv.appendChild(cityDiv);
                } else {
                    infoDiv.appendChild(nameDiv);
                    infoDiv.appendChild(addressDiv);
                }

                // Entfernung anzeigen wenn verf√ºgbar
                if (c.distance !== null) {
                    const distanceDiv = document.createElement('div');
                    distanceDiv.className = 'consultant-distance';
                    distanceDiv.textContent = `${Math.round(c.distance)} km entfernt`;
                    infoDiv.appendChild(distanceDiv);
                }

                // Expertise anzeigen
                if (c.expertise && c.expertise.length > 0) {
                    const expertiseNames = getExpertiseNames(c.expertise);
                    if (expertiseNames.length > 0) {
                        const expertiseDiv = document.createElement('div');
                        expertiseDiv.className = 'consultant-expertise';

                        expertiseNames.forEach(name => {
                            const tag = document.createElement('span');
                            tag.className = 'expertise-tag';
                            tag.textContent = name;
                            expertiseDiv.appendChild(tag);
                        });

                        infoDiv.appendChild(expertiseDiv);
                    }
                }

                item.appendChild(imgElement);
                item.appendChild(infoDiv);
                listContainer.appendChild(item);
            });

            // Zeige eine Nachricht wenn keine Ergebnisse gefunden wurden
            if (filteredConsultants.length === 0 && (nameFilter || activeExpertiseFilters.size > 0) && consultants.length > 0) {
                const noResults = document.createElement('div');
                noResults.style.textAlign = 'center';
                noResults.style.padding = '20px';
                noResults.style.opacity = '0.7';
                noResults.textContent = 'Keine Berater gefunden.';
                listContainer.appendChild(noResults);
            }

            console.log('Render complete. List container children:', listContainer.children.length);
        }

        // Event Listeners
        fab.addEventListener('click', () => {
            panel.classList.toggle('open');

            // Wenn Panel ge√∂ffnet wird und keine Daten da sind, zeige die geladenen Daten
            if (panel.classList.contains('open') && consultants.length > 0) {
                renderList();
            }
        });

        searchInput.addEventListener('input', (e) => {
            renderList(e.target.value);
        });

        // Location search events
        locationInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();

            if (query.length < 3) {
                cityResults.style.display = 'none';
                citySelect.style.display = 'none';
                return;
            }

            const locations = await searchLocation(query);
            renderCityResults(locations);

            // Legacy dropdown logic (kann entfernt werden, wenn nur Liste gew√ºnscht wird)
            if (locations.length > 0) {
                citySelect.innerHTML = '<option value="">Stadt ausw√§hlen...</option>';
                locations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify({
                        lat: parseFloat(location.lat),
                        lng: parseFloat(location.lon),
                        display_name: location.display_name
                    });
                    option.textContent = location.display_name;
                    citySelect.appendChild(option);
                });
            }
        });

        // Verstecke Ergebnisse wenn au√üerhalb geklickt wird
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#location-search')) {
                cityResults.style.display = 'none';
            }
        });

        citySelect.addEventListener('change', (e) => {
            if (e.target.value) {
                userLocation = JSON.parse(e.target.value);
                console.log('Selected location:', userLocation);
                updateDistances();
                citySelect.style.display = 'none';
                locationInput.value = userLocation.display_name;
            }
        });

        // Suchbutton Event Listener
        const searchButton = document.querySelector('#expert-search button');
        if (searchButton) {
            searchButton.addEventListener('click', () => {
                renderList(searchInput.value);
            });
        }

        // Lade Daten beim Seitenstart
        async function initializeData() {
            console.log('Initializing data...');
            await Promise.all([
                fetchConsultants(),
                fetchExpertise()
            ]);
        }

        // Fallback falls DOMContentLoaded bereits gefeuert wurde
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeData);
        } else {
            console.log('Page already loaded, initializing data immediately...');
            initializeData();
        }
    })();
</script>