<style>
    /* Expert Panel */
    #expert-panel {
        position: fixed;
        top: 0;
        right: 0;
        width: 33%;
        height: 100vh;
        background-color: #204060;
        color: white;
        box-shadow: -2px 0 6px rgba(0, 0, 0, 0.3);
        z-index: 2147483646;
        padding: 20px;
        display: flex;
        flex-direction: column;
        visibility: visible;
        overflow-y: auto;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
    }

    /* Header */
    #expert-panel h2 {
        margin: 0 0 15px;
        font-size: 1.4rem;
        flex-shrink: 0;
    }

    /* Consultant List Container */
    #consultant-list {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
        padding-right: 5px;
        min-height: 200px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 10px;
    }

    /* Consultant Card */
    .consultant {
        background: #173a59;
        border-radius: 8px;
        padding: 15px;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .consultant:hover {
        background: #102840;
    }

    .consultant img {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        margin-right: 15px;
        object-fit: cover;
        flex-shrink: 0;
    }

    .consultant-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .consultant-name {
        font-weight: bold;
        font-size: 1.1rem;
    }

    .consultant-subtitle {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 4px;
    }

    .consultant-city {
        font-size: 0.85rem;
        color: white;
        margin-top: 2px;
    }

    .consultant-distance {
        font-size: 0.85rem;
        color: #4CAF50;
        margin-top: 4px;
        font-weight: bold;
    }

    /* Sticky Footer Menu */
    #footer-menu {
        padding-top: 15px;
        flex-shrink: 0;
        background: #204060;
        position: sticky;
        bottom: 0;
        backdrop-filter: blur(5px);
    }

    #footer-menu h4 {
        margin: 0 0 10px;
        font-size: 1rem;
        opacity: 0.9;
    }

    /* Unified Search */
    #unified-search-section {
        margin-bottom: 15px;
    }

    #unified-search {
        position: relative;
        display: flex;
    }

    #unified-search input {
        flex: 1;
        padding: 8px 12px;
        border: none;
        border-radius: 4px 0 0 4px;
        font-size: 0.9rem;
    }

    #unified-search button {
        background: white;
        border: none;
        border-radius: 0 4px 4px 0;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9rem;
    }

    /* Search Results Dropdown */
    #search-results-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        color: #333;
        border-radius: 4px;
        margin-top: 2px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        border: 1px solid #ddd;
    }

    .search-result-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-result-item:hover {
        background-color: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .search-result-type {
        font-size: 0.8rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: bold;
        white-space: nowrap;
    }

    .search-result-type.location {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
    }

    .search-result-type.consultant {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .search-result-content {
        flex: 1;
        min-width: 0;
    }

    .search-result-name {
        font-weight: bold;
        font-size: 0.9rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .search-result-details {
        font-size: 0.8rem;
        color: #666;
        margin-top: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Current Location Display */
    #current-location {
        margin-bottom: 10px;
        padding: 6px 8px;
        background: rgba(76, 175, 80, 0.1);
        border-radius: 4px;
        border-left: 3px solid #4CAF50;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
    }

    #current-location small {
        color: #4CAF50;
        font-size: 0.8rem;
    }

    #clear-location {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        font-size: 0.8rem;
    }

    #clear-location:hover {
        color: #ff4444 !important;
    }

    /* Expertise Dropdown */
    #expertise-filter-container {
        margin-bottom: 15px;
    }

    #main-expertise-select,
    #child-expertise-select {
        width: 100%;
        padding: 8px;
        border: none;
        border-radius: 4px;
        margin-bottom: 8px;
        background: white;
        color: #333;
        font-size: 0.9rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 16px;
    }

    #child-expertise-select {
        display: none;
    }

    /* Loading and Error States */
    .loading {
        text-align: center;
        padding: 20px;
        opacity: 0.7;
    }

    .error {
        text-align: center;
        padding: 20px;
        color: #ff6b6b;
        background-color: rgba(255, 107, 107, 0.1);
        border-radius: 4px;
        margin: 10px 0;
    }

    .no-results {
        text-align: center;
        padding: 20px;
        color: rgba(255, 255, 255, 0.5);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        #expert-panel {
            width: 90%;
            right: 5%;
        }
    }

    @media (max-width: 480px) {
        #expert-panel {
            width: 95%;
            right: 2.5%;
        }
    }
</style>


<div id="expert-panel">
    <h2>Finde einen Experten in deiner N√§he!</h2>

    <div id="consultant-list"></div>

    <div id="footer-menu">
        <div id="unified-search-section">
            <div id="unified-search">
                <input type="text" id="unified-search-input" placeholder="Berater oder Ort suchen...">
                <button type="button" id="search-button">üîç</button>
                <div id="search-results-dropdown"></div>
            </div>
            <div id="current-location" style="display: none;">
                <small>üìç Standort f√ºr Entfernung: <span id="location-display"></span></small>
                <button type="button" id="clear-location">‚úï</button>
            </div>
        </div>

        <div id="expertise-filter-container">
            <h4>Nach Expertise filtern:</h4>
            <select id="main-expertise-select">
                <option value="">Alle Expertisen</option>
            </select>
            <select id="child-expertise-select">
                <option value="">Alle spezifischen Expertisen</option>
            </select>
        </div>
    </div>
</div>

<script>
    (function () {
        let consultants = [];
        let expertiseData = [];
        let isLoading = false;
        let userLocation = null;
        let currentSearchQuery = '';
        let searchTimeout;

        const listContainer = document.getElementById('consultant-list');
        const unifiedSearchInput = document.getElementById('unified-search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsDropdown = document.getElementById('search-results-dropdown');
        const currentLocationDiv = document.getElementById('current-location');
        const locationDisplay = document.getElementById('location-display');
        const clearLocationButton = document.getElementById('clear-location');
        const mainExpertiseSelect = document.getElementById('main-expertise-select');
        const childExpertiseSelect = document.getElementById('child-expertise-select');

        // Utility Functions
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getExpertiseNames(expertiseIds) {
            return expertiseIds
                .map(id => expertiseData.find(exp => exp.id === id))
                .filter(exp => exp)
                .map(exp => exp.name);
        }

        // Search & Location Functions
        async function searchLocation(query) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=de&limit=10`);
                const data = await response.json();
                const cityTypes = ['city', 'town', 'village', 'municipality', 'administrative'];
                return data.filter(location => {
                    return cityTypes.includes(location.type) ||
                        cityTypes.includes(location.class) ||
                        (location.addresstype && ['city', 'town', 'village', 'municipality'].includes(location.addresstype));
                }).slice(0, 5);
            } catch (error) {
                console.error('Error searching location:', error);
                return [];
            }
        }

        async function performUnifiedSearch(query) {
            if (!query || query.length < 2) {
                searchResultsDropdown.style.display = 'none';
                return;
            }

            const results = [];
            const consultantMatches = consultants.filter(c => {
                return c.name.toLowerCase().includes(query.toLowerCase()) ||
                    c.city.toLowerCase().includes(query.toLowerCase()) ||
                    c.address.toLowerCase().includes(query.toLowerCase());
            }).slice(0, 3);

            consultantMatches.forEach(c => {
                results.push({
                    type: 'consultant',
                    data: c,
                    name: c.name,
                    details: `${c.city}${c.address ? ', ' + c.address : ''}`
                });
            });

            if (query.length >= 3) {
                try {
                    const locations = await searchLocation(query);
                    locations.slice(0, 3).forEach(location => {
                        const parts = location.display_name.split(',');
                        const cityName = parts[0] + (parts[1] ? ', ' + parts[1].trim() : '');
                        results.push({
                            type: 'location',
                            data: location,
                            name: cityName,
                            details: location.display_name
                        });
                    });
                } catch (error) {
                    console.error('Error searching locations:', error);
                }
            }

            renderSearchResults(results);
        }

        function renderSearchResults(results) {
            searchResultsDropdown.innerHTML = '';
            if (results.length === 0) {
                searchResultsDropdown.style.display = 'none';
                return;
            }

            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const typeTag = document.createElement('div');
                typeTag.className = `search-result-type ${result.type}`;
                typeTag.textContent = result.type === 'consultant' ? 'üë§' : 'üìç';
                const content = document.createElement('div');
                content.className = 'search-result-content';
                const name = document.createElement('div');
                name.className = 'search-result-name';
                name.textContent = result.name;
                const details = document.createElement('div');
                details.className = 'search-result-details';
                details.textContent = result.details;

                content.appendChild(name);
                content.appendChild(details);
                item.appendChild(typeTag);
                item.appendChild(content);
                item.onclick = () => selectSearchResult(result);
                searchResultsDropdown.appendChild(item);
            });
            searchResultsDropdown.style.display = 'block';
        }

        function selectSearchResult(result) {
            if (result.type === 'consultant') {
                currentSearchQuery = result.name;
                unifiedSearchInput.value = result.name;
                searchResultsDropdown.style.display = 'none';
                renderList(result.name);
            } else if (result.type === 'location') {
                selectLocation(result.data);
                unifiedSearchInput.value = '';
                searchResultsDropdown.style.display = 'none';
            }
        }

        function selectLocation(location) {
            userLocation = {
                lat: parseFloat(location.lat),
                lng: parseFloat(location.lon),
                display_name: location.display_name
            };
            const parts = location.display_name.split(',');
            const cityName = parts[0] + (parts[1] ? ', ' + parts[1].trim() : '');
            locationDisplay.textContent = cityName;
            currentLocationDiv.style.display = 'flex';
            currentSearchQuery = '';
            updateDistances();
        }

        function clearLocation() {
            userLocation = null;
            currentLocationDiv.style.display = 'none';
            consultants.forEach(c => c.distance = null);
            renderList(currentSearchQuery);
        }

        // Data & Rendering Functions
        async function fetchConsultants() {
            if (isLoading) return;
            isLoading = true;
            showLoading();
            try {
                const response = await fetch('https://bsc-experten.de/wp-json/wp/v2/berater?per_page=100');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                consultants = data.map(c => ({
                    name: c.title.rendered,
                    image: c.yoast_head_json?.og_image?.[0]?.url || `https://via.placeholder.com/150x150/1d4b73/ffffff?text=${encodeURIComponent(c.title.rendered.charAt(0))}`,
                    link: c.link,
                    id: c.id,
                    address: c.acf?.['berater-anschrift'] || '',
                    city: c.acf?.['berater-ort'] || '',
                    subtitle: c.acf?.['experte_fuer'] || 'BSC | Die Finanzberater',
                    latitude: c.acf?.openstreetmap?.lat || null,
                    longitude: c.acf?.openstreetmap?.lng || null,
                    expertise: (c.expertise || []).map(id => parseInt(id)).filter(id => !isNaN(id)),
                    distance: null
                }));
                renderList();
            } catch (error) {
                console.error('Fehler beim Laden der Berater:', error);
                showError('Fehler beim Laden der Berater. Bitte versuchen Sie es sp√§ter erneut.');
            } finally {
                isLoading = false;
            }
        }

        async function fetchExpertise() {
            try {
                const response = await fetch('https://bsc-experten.de/wp-json/wp/v2/expertise?per_page=100');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const rawData = await response.json();
                expertiseData = rawData.map(exp => ({
                    ...exp,
                    id: parseInt(exp.id),
                    parent: parseInt(exp.parent) || 0
                }));
                renderExpertiseDropdowns();
            } catch (error) {
                console.error('Fehler beim Laden der Expertise:', error);
            }
        }

        function updateDistances() {
            if (!userLocation) return;
            consultants.forEach(c => {
                if (c.latitude && c.longitude) {
                    c.distance = calculateDistance(userLocation.lat, userLocation.lng, c.latitude, c.longitude);
                } else {
                    c.distance = null;
                }
            });
            // Sort in ascending order (closest first)
            consultants.sort((a, b) => {
                if (a.distance === null && b.distance === null) return 0;
                if (a.distance === null) return 1;
                if (b.distance === null) return -1;
                return a.distance - b.distance;
            });
            renderList(currentSearchQuery);
        }

        function renderExpertiseDropdowns() {
            const mainExpertises = expertiseData.filter(exp => exp.parent === 0).sort((a, b) => a.name.localeCompare(b.name));
            mainExpertiseSelect.innerHTML = '<option value="">Alle Expertisen</option>';
            mainExpertises.forEach(exp => {
                const option = document.createElement('option');
                option.value = exp.id;
                option.textContent = exp.name;
                mainExpertiseSelect.appendChild(option);
            });
            updateChildExpertiseDropdown();
        }

        function updateChildExpertiseDropdown() {
            const selectedMainId = mainExpertiseSelect.value;
            childExpertiseSelect.innerHTML = '<option value="">Alle spezifischen Expertisen</option>';

            if (!selectedMainId) {
                childExpertiseSelect.style.display = 'none';
                return;
            }

            const childExpertises = expertiseData.filter(exp => exp.parent === parseInt(selectedMainId)).sort((a, b) => a.name.localeCompare(b.name));
            if (childExpertises.length > 0) {
                childExpertiseSelect.style.display = 'block';
                childExpertises.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.id;
                    option.textContent = exp.name;
                    childExpertiseSelect.appendChild(option);
                });
            } else {
                childExpertiseSelect.style.display = 'none';
            }
        }

        function renderList(nameFilter = "") {
            if (isLoading) return;
            listContainer.innerHTML = "";
            const selectedMainId = mainExpertiseSelect.value;
            const selectedChildId = childExpertiseSelect.value;

            let filteredConsultants = consultants.filter(c => {
                const matchesName = !nameFilter ||
                    c.name.toLowerCase().includes(nameFilter.toLowerCase()) ||
                    c.city.toLowerCase().includes(nameFilter.toLowerCase()) ||
                    c.address.toLowerCase().includes(nameFilter.toLowerCase());

                let matchesExpertise = (selectedMainId === "" && selectedChildId === "") ||
                    (selectedChildId !== "" && c.expertise.includes(parseInt(selectedChildId)));

                if (selectedMainId !== "" && selectedChildId === "") {
                    // Check if consultant has main expertise or any of its children
                    const relatedExpertiseIds = expertiseData
                        .filter(exp => exp.id === parseInt(selectedMainId) || exp.parent === parseInt(selectedMainId))
                        .map(exp => exp.id);
                    matchesExpertise = c.expertise.some(id => relatedExpertiseIds.includes(id));
                }

                return matchesName && matchesExpertise;
            });

            if (filteredConsultants.length === 0) {
                listContainer.innerHTML = '<div class="no-results">Keine Berater gefunden, die Ihren Kriterien entsprechen.</div>';
                return;
            }

            filteredConsultants.forEach(c => {
                const item = document.createElement('div');
                item.className = 'consultant';
                item.onclick = () => window.open(c.link, '_blank');

                const imgElement = document.createElement('img');
                imgElement.src = c.image;
                imgElement.alt = c.name;
                imgElement.onerror = function () {
                    this.src = `https://via.placeholder.com/100x100/1d4b73/ffffff?text=${encodeURIComponent(c.name.charAt(0))}`;
                };

                const infoDiv = document.createElement('div');
                infoDiv.className = 'consultant-info';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'consultant-name';
                nameDiv.textContent = c.name;

                const subtitleDiv = document.createElement('div');
                subtitleDiv.className = 'consultant-subtitle';
                subtitleDiv.textContent = c.subtitle;

                const cityDiv = document.createElement('div');
                cityDiv.className = 'consultant-city';
                cityDiv.textContent = c.city;

                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(subtitleDiv);
                infoDiv.appendChild(cityDiv);

                if (c.distance !== null) {
                    const distanceDiv = document.createElement('div');
                    distanceDiv.className = 'consultant-distance';
                    distanceDiv.textContent = `${Math.round(c.distance)} km entfernt`;
                    infoDiv.appendChild(distanceDiv);
                }

                item.appendChild(imgElement);
                item.appendChild(infoDiv);
                listContainer.appendChild(item);
            });
        }

        function showLoading() {
            listContainer.innerHTML = '<div class="loading">Lade Berater...</div>';
        }

        function showError(message) {
            listContainer.innerHTML = `<div class="error">${message}</div>`;
        }

        // Event Listeners
        unifiedSearchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performUnifiedSearch(currentSearchQuery);
            }, 300);
            renderList(currentSearchQuery);
        });

        searchButton.addEventListener('click', () => {
            searchResultsDropdown.style.display = 'none';
            renderList(currentSearchQuery);
        });

        clearLocationButton.addEventListener('click', clearLocation);

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#unified-search')) {
                searchResultsDropdown.style.display = 'none';
            }
        });

        mainExpertiseSelect.addEventListener('change', () => {
            childExpertiseSelect.value = '';
            updateChildExpertiseDropdown();
            renderList(currentSearchQuery);
        });

        childExpertiseSelect.addEventListener('change', () => {
            renderList(currentSearchQuery);
        });

        // Initialization
        async function initializeData() {
            await Promise.all([
                fetchConsultants(),
                fetchExpertise()
            ]);
            renderList();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeData);
        } else {
            setTimeout(initializeData, 100);
        }
    })();
</script>